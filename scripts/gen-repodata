#!/bin/bash
set -e
# Parse command-line arguments using getopts
while getopts ":r:s:" opt; do
    case $opt in
        r)
            ROOT_DIR="$OPTARG"
            ;;
        s)
            GPG_SEC_ID="$OPTARG"
            ;;
        \?)
            echo "‚ùå Invalid option: -$OPTARG" >&2
            exit 1
            ;;
        :)
            echo "‚ö†Ô∏è Option -$OPTARG requires an argument" >&2
            exit 1
            ;;
    esac
done

# Check if -r argument is provided
if [ -z "$ROOT_DIR" ]; then
    echo "‚ÑπÔ∏è Usage: $0 -r ROOT_DIR [-s GPG_KEY_FINGERPRINT]"
    exit 1
fi

# Check if the root directory exists
if [ ! -d "$ROOT_DIR" ]; then
    echo "‚ùå Error: Root directory $ROOT_DIR does not exist"
    exit 1
fi

# Search for second-level directories
find "$ROOT_DIR" -mindepth 2 -maxdepth 2 -type d | while read -r second_level; do
    # Check if noarch, x86_64, or source directory exists inside
    for arch in noarch x86_64 source; do
        if [ -d "$second_level/$arch" ]; then
            echo "üöÄ Found $arch in $second_level, running createrepo..."
            if command -v createrepo_c > /dev/null; then
                createrepo_c "$second_level"
            elif command -v createrepo > /dev/null; then
                createrepo "$second_level"
            else
                echo "‚ùå Error: createrepo or createrepo_c not found in PATH"
            fi

            # If GPG key is provided, sign repomd.xml
            if [ -n "$GPG_SEC_ID" ]; then
                REPO_MD="$second_level/repodata/repomd.xml"
                if [ -f "$REPO_MD" ]; then
                    echo "‚úçÔ∏è  Signing $REPO_MD with GPG key $GPG_SEC_ID..."
                    gpg --detach-sign --armor --batch --yes \
                        --local-user "$GPG_SEC_ID" "$REPO_MD"
                else
                    echo "‚ö†Ô∏è  Warning: $REPO_MD not found, skipping signature."
                fi
            fi

            break  # Run createrepo only once per second-level directory
        fi
    done
done

echo "‚úÖ All matching directories processed."
